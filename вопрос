import telebot
import psycopg2
from telebot import types

try:
    conn = psycopg2.connect(user='postgres', password='123', host='localhost', database='postgres', port='5432')
    cursor = conn.cursor()

    bot = telebot.TeleBot('6677133821:AAGnImXMls88-1QUZQRvcsay7PdxmEuv1bM')
    admin_session = None

    def get_main_keyboard():
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
        item_products = types.KeyboardButton('Продукты')
        item_users = types.KeyboardButton('Пользователи')
        item_add_product = types.KeyboardButton('Добавить продукт')
        item_delete_product = types.KeyboardButton('Удалить продукт')
        item_delete_user = types.KeyboardButton('Удалить пользователя')
        item_delete_all_users = types.KeyboardButton('Удалить всех пользователей')
        markup.add(item_products, item_users, item_add_product, item_delete_product, item_delete_user, item_delete_all_users)
        return markup

    def start_message(message):
        global admin_session
        try:
            bot.send_message(message.chat.id, "Пожалуйста, введите логин:")
            bot.register_next_step_handler(message, handle_start)
        except Exception as e:
            print(f"Error handling start message: {e}")
            bot.send_message(message.chat.id, f"Ошибка: {e}")

    def handle_start(message):
        global admin_session
        try:
            admin_login = message.text.strip()
            cursor.execute("SELECT * FROM admin WHERE name = %s", (admin_login,))
            admin_data = cursor.fetchone()

            if admin_data:
                admin_session = admin_login
                markup = get_main_keyboard()
                bot.send_message(message.chat.id, f"Вы успешно вошли в аккаунт администратора, {admin_login}.", reply_markup=markup)
            else:
                bot.send_message(message.chat.id, "Неверный логин. Попробуйте снова.")
                start_message(message)
        except Exception as e:
            print(f"Error handling start: {e}")
            bot.send_message(message.chat.id, f"Ошибка: {e}")

    @bot.message_handler(commands=['start'])
    def start(message):
        start_message(message)

    def start_message(message):
        global admin_session
        try:
            msg = bot.send_message(message.chat.id, "Пожалуйста, введите логин:")
            bot.register_next_step_handler(msg, handle_start)
        except Exception as e:
            print(f"Error handling start message: {e}")
            bot.send_message(message.chat.id, f"Ошибка: {e}")


    @bot.message_handler(func=lambda message: message.text == 'Пользователи')
    def handle_users(message):
        try:
            cursor.execute("SELECT * FROM users")
            users = cursor.fetchall()

            if not users:
                bot.send_message(message.chat.id, "Пользователей нет.")
            else:
                user_list = "\n".join([f"Логин: {user[0]}\nПароль: {user[1]}" for user in users])
                bot.send_message(message.chat.id, user_list)

            markup = get_main_keyboard()
            bot.send_message(message.chat.id, "Список пользователей отправлен.", reply_markup=markup)

        except psycopg2.Error as e:
            print(f"Database error: {e}")
            bot.send_message(message.chat.id, f"Ошибка при получении пользователей: {e}")


   
    @bot.message_handler(func=lambda message: message.text == 'Удалить пользователя')
    def handle_delete_user_request(message):
        try:
            markup = types.ReplyKeyboardRemove(selective=False)
            bot.send_message(message.chat.id, "Пожалуйста, укажите логин пользователя для удаления:", reply_markup=markup)

            bot.register_next_step_handler(message, handle_delete_user)

        except Exception as e:
            print(f"Error requesting user login for deletion: {e}")
            bot.send_message(message.chat.id, f"Ошибка при запросе логина пользователя для удаления: {e}")

    def handle_delete_user(message):
        try:
            login_to_delete = message.text.strip()

            delete_query = "DELETE FROM users WHERE login = %s"
            cursor.execute(delete_query, (login_to_delete,))
            conn.commit()

            bot.send_message(message.chat.id, f"Пользователь с логином '{login_to_delete}' успешно удален.")

        except Exception as e:
            print(f"Error deleting user: {e}")
            bot.send_message(message.chat.id, f"Ошибка при удалении пользователя: {e}")

        markup = get_main_keyboard()
        bot.send_message(message.chat.id, "Операция удаления пользователя завершена.", reply_markup=markup)

    @bot.message_handler(func=lambda message: message.text == 'Удалить всех пользователей')
    def handle_delete_all_users_request(message):
        try:
            markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
            item_yes = types.KeyboardButton('Да')
            item_no = types.KeyboardButton('Нет')
            markup.add(item_yes, item_no)

            bot.send_message(message.chat.id, "Вы уверены, что хотите удалить всех пользователей?", reply_markup=markup)
            bot.register_next_step_handler(message, handle_confirm_delete_all_users)

        except Exception as e:
            print(f"Error requesting confirmation for deleting all users: {e}")
            bot.send_message(message.chat.id, f"Ошибка при запросе подтверждения удаления всех пользователей: {e}")

    def handle_confirm_delete_all_users(message):
        try:
            if message.text.lower() == 'да':
                cursor.execute("DELETE FROM users")
                conn.commit()
                bot.send_message(message.chat.id, "Все пользователи успешно удалены.")
            else:
                bot.send_message(message.chat.id, "Операция удаления всех пользователей отменена.")

            markup = get_main_keyboard()
            bot.send_message(message.chat.id, "Операция завершена.", reply_markup=markup)

        except Exception as e:
            print(f"Error handling confirmation for deleting all users: {e}")
            bot.send_message(message.chat.id, f"Ошибка при обработке подтверждения удаления всех пользователей: {e}")

    @bot.message_handler(func=lambda message: True)
    def handle_other(message):
        bot.send_message(message.chat.id, "Я не понимаю эту команду.")

    bot.polling()
@bot.message_handler(func=lambda message: message.text == 'Добавить продукт')
def handle_add_product(message):
    try:
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
        item_monitors = types.KeyboardButton('Мониторы')
        item_motherboards = types.KeyboardButton('Материнские платы')
        item_laptops = types.KeyboardButton('Ноутбуки')
        item_personal_computers = types.KeyboardButton('Персональные компьютеры')
        markup.add(item_monitors, item_motherboards, item_laptops, item_personal_computers)

        bot.send_message(message.chat.id, "Выберите категорию продукта для добавления:", reply_markup=markup)
        bot.register_next_step_handler(message, handle_add_product_category)
    except Exception as e:
        print(f"Error handling add product request: {e}")
        bot.send_message(message.chat.id, f"Ошибка при запросе добавления продукта: {e}")

def handle_add_product_category(message):
    try:
        category = message.text.lower()
        if category in ['мониторы', 'материнские платы', 'ноутбуки', 'персональные компьютеры']:
            # В зависимости от категории вызывайте соответствующую функцию добавления продукта
            if category == 'мониторы':
                # Добавление монитора
                add_monitor(message)
            elif category == 'материнские платы':
                # Добавление материнской платы
                add_motherboard(message)
            elif category == 'ноутбуки':
                # Добавление ноутбука
                add_laptop(message)
            elif category == 'персональные компьютеры':
                # Добавление персонального компьютера
                add_personal_computer(message)
        else:
            bot.send_message(message.chat.id, "Некорректная категория. Попробуйте снова.")
            handle_add_product(message)
    except Exception as e:
        print(f"Error handling add product category: {e}")
        bot.send_message(message.chat.id, f"Ошибка при обработке категории добавления продукта: {e}")
@bot.message_handler(func=lambda message: message.text == 'Продукты')
def handle_view_products(message):
    try:
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
        item_monitors = types.KeyboardButton('Мониторы')
        item_motherboards = types.KeyboardButton('Материнские платы')
        item_laptops = types.KeyboardButton('Ноутбуки')
        item_personal_computers = types.KeyboardButton('Персональные компьютеры')
        markup.add(item_monitors, item_motherboards, item_laptops, item_personal_computers)

        bot.send_message(message.chat.id, "Выберите категорию продукта для просмотра:", reply_markup=markup)
        bot.register_next_step_handler(message, handle_view_products_category)
    except Exception as e:
        print(f"Error handling view products request: {e}")
        bot.send_message(message.chat.id, f"Ошибка при запросе просмотра продуктов: {e}")

def handle_view_products_category(message):
    try:
        category = message.text.lower()
        if category in ['мониторы', 'материнские платы', 'ноутбуки', 'персональные компьютеры']:
            # В зависимости от категории вызывайте соответствующую функцию просмотра продуктов
            view_products(message, category)
        else:
            bot.send_message(message.chat.id, "Некорректная категория. Попробуйте снова.")
            handle_view_products(message)
    except Exception as e:
        print(f"Error handling view products category: {e}")
        bot.send_message(message.chat.id, f"Ошибка при обработке категории просмотра продуктов: {e}")
@bot.message_handler(func=lambda message: message.text == 'Удалить продукт')
def handle_delete_product(message):
    try:
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
        item_monitors = types.KeyboardButton('Мониторы')
        item_motherboards = types.KeyboardButton('Материнские платы')
        item_laptops = types.KeyboardButton('Ноутбуки')
        item_personal_computers = types.KeyboardButton('Персональные компьютеры')
        markup.add(item_monitors, item_motherboards, item_laptops, item_personal_computers)

        bot.send_message(message.chat.id, "Выберите категорию продукта для удаления:", reply_markup=markup)
        bot.register_next_step_handler(message, handle_delete_product_category)
    except Exception as e:
        print(f"Error handling delete product request: {e}")
        bot.send_message(message.chat.id, f"Ошибка при запросе удаления продукта: {e}")

def handle_delete_product_category(message):
    try:
        category = message.text.lower()
        if category in ['мониторы', 'материнские платы', 'ноутбуки', 'персональные компьютеры']:
            # В зависимости от категории вызывайте соответствующую функцию удаления продукта
            delete_product(message, category)
        else:
            bot.send_message(message.chat.id, "Некорректная категория. Попробуйте снова.")
            handle_delete_product(message)
    except Exception as e:
        print(f"Error handling delete product category: {e}")
        bot.send_message(message.chat.id, f"Ошибка при обработке категории удаления продукта: {e}")

    except Exception as e:
        print(f"Ошибка при подключении к базе данных: {e}")

    finally:
        try:
            if cursor:
                cursor.close()
            if conn:
                conn.close()
        except Exception as close_error:
            print(f"Error closing the database connection: {close_error}")

        exit()
